Установка
---------

1. Скопировать папку ProstieZvonki.
2. Создать файл config.ini и указать в нём настройки подключения к серверу. За основу можно взять файл config.init.example.
3. Убедиться, что этот пользователь имеет право и запись в папку storage и её подпапки, а также в папку lib/ListenerProcess и файл config.ini. 
4. Убедиться, что пользователь, из-под которого запущен веб-сервер, имеет права на запуск процессов.

API
---

### Получение ссылки на объект ПростыеЗвонки

```php
$pz = prostiezvonki::getInstance();
```

### Подключение к серверу

```php
$pz->connect(array(
	'client_id'     => '101',       // Пароль
	'client_type'   => 'tinyCRM',   // Тип приложения
	'host'          => 'localhost', // Хост сервера
	'port'          => '10150',     // Порт сервера
));
```

> Не следует вручную изменять настройки в файле config.ini — они будут автоматически перезаписаны.

### Разрыв подключения

```php
$pz->disconnect();
```

### Исходящий звонок

```php
$pz->call(
	$src, // номер телефона, с которого будет совершён звонок
	$dst  // номер телефона, на который будет совершён звонок
);
```

### Перевод звонка

Перевод звонка работает следующим образом.

При входящем звонке сервер Простых Звонков отправляет клиентскому приложению событие с типом OnIncomingCall, в котором содержится идентификатор звонка и номер, с которого совершается этот звонок.

Клиентское приложение принимает решение, на какой внутренний номер следует направить этот звонок, и отправляет серверу событие, содержащее полученный ранее идентификатор звонка и внутренний номер.

```php
$pz->transfer(
	$callID, // идентификатор звонка, полученный от сервера
	$dst     // номер телефона, на который нужно перевести звонок
);
```

### Получение событий

```php
$pz->getEvents();
```

Метод возвращает массив событий. Каждое событие представляет собой ассоциативный массив.

#### Типы событий

Существует 3 типа событий:

- входящий вызов на переадресацию
- входящий вызов на менеджера
- завершенный вызов

При получении события о входящем вызове на переадресацию, модуль CRM должен решить, нужно ли перенаправить вызов или нет. В случае перенаправления, модуль CRM должен вызвать функцию Transfer с соответствующим идентификатором звонка (полученным из соответствующего события входящего вызова на переадресацию) и номером, на который нужно сделать перенаправление. В случае отсутствия необходимости перенаправления, модуль CRM должен вызвать функцию Transfer с пустым номером.

Событие "входящий вызов на переадресацию" должно быть отправлено всем подключенным CRM. При получении ответа Transfer с не пустым номером от нескольких CRM, следует перенаправить вызов на номер, полученный первым.

Событие "входящий вызов на менеджера" должно быть отправлено только тому CRM, который первый ответил на запрос на переадресацию.

Событие "завершенный вызов" должно быть отправлено все подключенным CRM.


#### Примеры событий:

Входящий вызов на переадресацию

```php
array(
	type   => "1",          // Тип события: "1"
	callID => "12345",      // Идентификатор звонка
    from   => "+7999999999" // Номер звонящего абонента 
)
```

Входящий вызов на менеджера

```php
array(
	type   => "2",           // Тип события: "2"
	callID => "12345",       // Идентификатор звонка
	from   => "+7999999999", // Номер звонящего абонента
	to     => "5365",        // Номер вызываемого абонента
)
```

Завершенный вызов

```php
array(
	type      => "4",          // Тип события: "4"
	callID    => "12345"       // Идентификатор звонка
	from      => "+7999999999" // Номер звонящего абонента
	to        => "5365"        // Номер вызываемого абонента
	start     => "1327491654"  // Время начала вызова, в формате Timestamp
	end       => "1327491714"  // Время окончания вызов, в формате Timestamp
	duration  => "60"          // Длина разговора, в секундах
	direction => "0"           // Направление вызова: 0 – входящий, 1 – исходящий
	record    => "ftp://somehost/12345.mp3" // Ссылка на файл записи
)
```

Тестирование
------------

В папке TestSuite находятся утилиты для отладки.

Тестовый сервер может быть запущен в двух режимах, с поддержкой шифрования:

```bash
TestSuite/TestServer.exe
```

или без него:

```bash
TestSuite/TestServer.exe -r
```

Для управления тестовым сервером нужно подключиться к нему с помощью утилиты Diagnostic:

```bash
TestSuite/Diagnostic.exe

[events off]> Connect ws://localhost:10150 asd
Успешно начато установление соединения с АТС
```

Теперь можно просмотреть список подключенных клиентов:

```bash
[events off]> Clients
0 Diagnostic 127.0.0.1 asd Connected
```

или сэмулировать входящий звонок с номера 223322 на номер 101:

```bash
[events off]> Generate transfer 223322 101
0 Diagnostic 127.0.0.1 asd Connected
```

Все возможности утилиты можно посмотреть с помощью команды help:

```bash
[events off]> Help
```