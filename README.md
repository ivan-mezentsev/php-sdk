Установка
---------

1. Скопировать папку ProstieZvonki.
2. Создать файл config.ini и указать в нём настройки подключения к серверу. За основу можно взять файл config.init.example.
3. Убедиться, что этот пользователь имеет право и запись в папку storage и её подпапки, а также в папку lib/ListenerProcess и файл config.ini. 
4. Убедиться, что пользователь, из-под которого запущен веб-сервер, имеет права на запуск процессов.

API
---

### Получение ссылки на объект ПростыеЗвонки

```php
$pz = prostiezvonki::getInstance();
```

### Подключение к серверу

```php
$pz->connect(array(
	'client_id'     => '101',       // Пароль
	'client_type'   => 'tinyCRM',   // Тип приложения
	'host'          => 'localhost', // Хост сервера
	'port'          => '10150',     // Порт сервера
));
```

> Не следует вручную изменять настройки в файле config.ini — они будут автоматически перезаписаны.

### Разрыв подключения

```php
$pz->disconnect();
```

### Исходящий звонок

```php
$pz->call(
	$src, // номер телефона, с которого будет совершён звонок
	$dst  // номер телефона, на который будет совершён звонок
);
```

### Перевод звонка

Перевод звонка работает следующим образом.

При входящем звонке сервер Простых Звонков отправляет клиентскому приложению событие с типом OnIncomingCall, в котором содержится идентификатор звонка и номер, с которого совершается этот звонок.

Клиентское приложение принимает решение, на какой внутренний номер следует направить этот звонок и отправляет серверу событие, содержащее полученный ранее идентификатор звонка и внутренний номер.

```php
$pz->transfer(
	$callID, // идентификатор звонка, полученный от сервера
	$dst     // номер телефона, на который нужно перевести звонок
);
```

### Получение событий

```php
$pz->getEvents();
```

Метод возвращает массив событий. Каждое событие представляет собой ассоциативный массив.

Тестирование
------------

В папке TestSuite находятся утилиты для отладки.

Тестовый сервер может быть запущен в двух режимах, с поддержкой шифрования:

```bash
TestSuite/TestServer.exe
```

или без него:

```bash
TestSuite/TestServer.exe -r
```

Для управления тестовым сервером нужно подключиться к нему с помощью утилиты Diagnostic:

```bash
TestSuite/Diagnostic.exe

[events off]> Connect localhost:10150 asd
Успешно начато установление соединения с АТС
```

Теперь можно просмотреть список подключенных клиентов:

```bash
[events off]> Clients
0 Diagnostic 127.0.0.1 asd Connected
```

или сэмулировать входящий звонок с номера 223322 на номер 101:

```bash
[events off]> Generate transfer 223322 101
0 Diagnostic 127.0.0.1 asd Connected
```

Все возможности утилиты можно посмотреть с помощью команды help:

```bash
[events off]> Help
```